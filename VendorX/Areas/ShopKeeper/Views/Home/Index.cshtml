@using VendorX.Models
@using VendorX.ViewModels

@{
    ViewData["Title"] = "Dashboard";
    var adminNotices = ViewBag.AdminNotices as List<AdminNoticeViewModel>;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center gap-3">
        @if (ViewBag.ShopName != null)
        {
            <div>
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="bi bi-speedometer2"></i> @ViewBag.ShopName Dashboard
                </h1>
            </div>
        }
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#qrCodeModal" title="Show Shop QR Code">
            <i class="bi bi-qr-code fs-5"></i>
        </button>
    </div>
   
    <div class="text-end">
        <small class="text-muted d-block">@DateTime.Now.ToString("dddd, MMMM dd, yyyy")</small>
        <small class="text-muted">@DateTime.Now.ToString("hh:mm tt")</small>
    </div>
</div>

<!-- Admin Notices Alert -->
@if (adminNotices != null && adminNotices.Any())
{
    foreach (var notice in adminNotices)
    {
        var alertClass = notice.NoticeType.ToLower() switch
        {
            "warning" => "alert-warning",
            "danger" => "alert-danger",
            "success" => "alert-success",
            _ => "alert-info"
        };

        <div class="alert @alertClass alert-dismissible fade show shadow-sm" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-megaphone"></i> @notice.Title
            </h5>
            <p class="mb-0">@notice.Message</p>
            @if (notice.ExpiresAt.HasValue)
            {
                <hr/>
                <small class="text-muted">
                    <i class="bi bi-clock"></i> Expires: @notice.ExpiresAt.Value.ToString("MMM dd, yyyy")
                </small>
            }
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
}

<!-- Statistics Cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card border-left-primary shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Today's Sales</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.TodaySales</div>
                        <small class="text-muted">@ViewBag.TodayTransactions Transactions</small>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-currency-dollar fs-2 text-primary"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white py-2">
                <a href="@Url.Action("Daily", "Reports")" class="text-primary text-decoration-none small">
                    View Daily Report <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card border-left-success shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Pending Orders</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.PendingOrders</div>
                        <small class="text-muted">Awaiting Delivery</small>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-bag-check fs-2 text-success"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white py-2">
                <a href="@Url.Action("Index", "Orders")" class="text-success text-decoration-none small">
                    Manage Orders <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card border-left-warning shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Total Baki</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.TotalBaki</div>
                        <small class="text-muted">Outstanding Credit</small>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-wallet2 fs-2 text-warning"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white py-2">
                <a href="@Url.Action("Index", "Baki")" class="text-warning text-decoration-none small">
                    Manage Baki <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card border-left-info shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Customers</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.TotalCustomers</div>
                        <small class="text-muted">Registered</small>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-people fs-2 text-info"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white py-2">
                <a href="@Url.Action("Index", "Customers")" class="text-info text-decoration-none small">
                    View Customers <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Sales & Baki Trend Chart with Tabs -->
    <div class="col-lg-8">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white py-2">
                <ul class="nav nav-tabs card-header-tabs" id="trendChartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active text-white py-1 px-2 small"
                                id="sales-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#salesTrend"
                                type="button"
                                role="tab">
                            <i class="bi bi-graph-up"></i> Sales Trend (7 days)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link text-white py-1 px-2 small"
                                id="baki-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#bakiTrend"
                                type="button"
                                role="tab">
                            <i class="bi bi-graph-up-arrow"></i> Baki Trend (7 Days)
                        </button>
                    </li>
                </ul>
            </div>

            <div class="card-body p-2 d-flex align-items-center">
                <div class="tab-content flex-fill" id="trendChartContent" style="height: 300px;">
                    <div class="tab-pane fade show active h-100" id="salesTrend" role="tabpanel">
                        <div id="salesChart" class="h-100"></div>
                    </div>
                    <div class="tab-pane fade h-100" id="bakiTrend" role="tabpanel">
                        <div id="bakiChart" class="h-100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- POS Sales Distribution Pie Chart -->
    <div class="col-lg-4">
        <div class="card shadow h-100">
            <div class="card-header bg-success text-white py-3">
                <i class="bi bi-pie-chart"></i> POS Sales Distribution
            </div>

            <div class="card-body p-2 d-flex align-items-center" style="height: 300px;">
                <div id="posPieChart" class="flex-fill h-100"></div>
            </div>
        </div>
    </div>
</div>


<!-- Quick Actions -->
<div class="col-lg-12 mb-4">
    <div class="card shadow">
        <div class="card-header">
            <i class="bi bi-lightning-charge"></i> Quick Actions
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <a href="@Url.Action("Index", "POS")" class="btn btn-primary w-100 btn-lg">
                        <i class="bi bi-cart-check d-block fs-2 mb-2"></i>
                        @* <strong>POS System</strong> *@
                        <small class="d-block">Process Sale</small>
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="@Url.Action("Create", "Orders")" class="btn btn-success w-100 btn-lg">
                        <i class="bi bi-plus-circle d-block fs-2 mb-2"></i>
                        @* <strong>New Order</strong> *@
                        <small class="d-block">Create Order</small>
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="@Url.Action("Index", "Products")" class="btn btn-info w-100 btn-lg">
                        <i class="bi bi-box-seam d-block fs-2 mb-2"></i>
                        @* <strong>Products</strong> *@
                        <small class="d-block">Manage Stock</small>
                    </a>
                </div>
            </div>

            <hr class="my-3" />

            <div class="row g-2">
                <div class="col-md-3">
                    <a href="@Url.Action("Index", "Categories")" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-tags"></i> Categories
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="@Url.Action("Index", "Customers")" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-people"></i> Customers
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="@Url.Action("Index", "Orders")" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-file-earmark-text"></i> Orders
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="@Url.Action("Index", "Baki")" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-graph-up"></i> Baki
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="row mb-4">
    <!-- Top Products -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-success text-white">
                <i class="bi bi-star"></i> Top Products (30 Days)
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                @if (ViewBag.TopProducts != null && ViewBag.TopProducts.Count > 0)
                {
                    <div class="list-group list-group-flush">
                        @foreach (var product in ViewBag.TopProducts)
                        {
                            <div class="list-group-item px-0 py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>@product.ProductName</strong>
                                        <small class="d-block text-muted">Sold: @product.TotalSold units</small>
                                    </div>
                                    <span class="badge bg-success">@product.Revenue.ToString("C")</span>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted text-center mb-0">No sales data available</p>
                }
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-info text-white">
                <i class="bi bi-clock-history"></i> Recent Transactions
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                @if (ViewBag.RecentTransactions != null && ViewBag.RecentTransactions.Count > 0)
                {
                    <div class="list-group list-group-flush">
                        @foreach (var transaction in ViewBag.RecentTransactions)
                        {
                            <div class="list-group-item px-0 py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>@transaction.TransactionNumber</strong>
                                        <small class="d-block text-muted">@transaction.CustomerName</small>
                                        <small class="text-muted">@transaction.TransactionDate.ToString("MMM dd, hh:mm tt")</small>
                                    </div>
                                    <span class="badge bg-primary">@transaction.TotalAmount.ToString("C")</span>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted text-center mb-0">No recent transactions</p>
                }
            </div>
        </div>
    </div>
</div>

<!-- Low Stock Alert -->
@if (ViewBag.LowStockProducts != null && ViewBag.LowStockProducts.Count > 0)
{
    <div class="alert alert-warning shadow-sm">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Low Stock Alert</h5>
        <p class="mb-2"><strong>The following products are running low on stock:</strong></p>
        <ul class="mb-0">
            @foreach (var product in ViewBag.LowStockProducts)
            {
                <li>@product.ProductName - <strong class="text-danger">@product.StockQuantity units remaining</strong></li>
            }
        </ul>
    </div>
}

<!-- Tips & Shortcuts -->
<div class="alert alert-info shadow-sm">
    <h5 class="alert-heading"><i class="bi bi-lightbulb"></i> Quick Tip</h5>
    <p class="mb-0">
        <strong>Did you know?</strong> You can quickly access the POS system using the sidebar or create orders for future delivery. 
        All transactions automatically send notifications to customers via email and WhatsApp!
    </p>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="qrCodeModalLabel">
                    <i class="bi bi-qr-code"></i> Shop QR Code
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                @if (ViewBag.Shop != null)
                {
                    var shop = ViewBag.Shop as VendorX.Models.Shop;
                    
                    <div class="mb-3">
                        <h4 class="text-primary">@shop.ShopName</h4>
                        @if (!string.IsNullOrEmpty(shop.Address))
                        {
                            <p class="text-muted mb-1">
                                <i class="bi bi-geo-alt"></i> @shop.Address
                            </p>
                        }
                        @if (!string.IsNullOrEmpty(shop.PhoneNumber))
                        {
                            <p class="text-muted mb-1">
                                <i class="bi bi-telephone"></i> @shop.PhoneNumber
                            </p>
                        }
                        @if (!string.IsNullOrEmpty(shop.Email))
                        {
                            <p class="text-muted mb-1">
                                <i class="bi bi-envelope"></i> @shop.Email
                            </p>
                        }
                    </div>
                    
                    <div class="qr-code-container p-3 bg-light rounded">
                        @if (!string.IsNullOrEmpty(shop.QRCode))
                        {
                            <img src="@shop.QRCode" alt="Shop QR Code" class="img-fluid" style="max-width: 300px;" />
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> QR Code not available
                            </div>
                        }
                    </div>
                    
                    @if (!string.IsNullOrEmpty(shop.ShopCode))
                    {
                        <div class="mt-3">
                            <small class="text-muted">Shop Code:</small>
                            <h5 class="text-primary font-monospace">@shop.ShopCode</h5>
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-circle"></i> Shop information not available
                    </div>
                }
                
                <div class="mt-3">
                    <small class="text-muted d-block">
                        <i class="bi bi-info-circle"></i> Customers can scan this QR code to register to your shop
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Close
                </button>
                <form asp-area="ShopKeeper" asp-controller="Shop" asp-action="RegenerateQRCode" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-warning" title="Regenerate QR Code with current server URL">
                        <i class="bi bi-arrow-clockwise"></i> Regenerate QR
                    </button>
                </form>
                <button type="button" class="btn btn-primary" onclick="printQRCode()">
                    <i class="bi bi-printer"></i> Print
                </button>
                <button type="button" class="btn btn-success" onclick="downloadQRCode()">
                    <i class="bi bi-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize charts immediately
            initializeCharts();
            
            // Re-render charts when tabs are switched
            $('#trendChartTabs button').on('shown.bs.tab', function (e) {
                var target = $(e.target).data('bs-target');
                if (target === '#salesTrend') {
                    Highcharts.charts.forEach(function(chart) {
                        if (chart && chart.renderTo.id === 'salesChart') {
                            chart.reflow();
                        }
                    });
                } else if (target === '#bakiTrend') {
                    Highcharts.charts.forEach(function(chart) {
                        if (chart && chart.renderTo.id === 'bakiChart') {
                            chart.reflow();
                        }
                    });
                }
            });
        });

        function initializeCharts() {
            // Sales Chart
            Highcharts.chart('salesChart', {
                chart: {
                    type: 'area'
                },
                title: {
                    text: null
                },
                xAxis: {
                    categories: @Html.Raw(ViewBag.ChartLabels)
                },
                yAxis: {
                    title: {
                        text: 'Sales Amount ($)'
                    }
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    area: {
                        fillColor: {
                            linearGradient: {
                                x1: 0,
                                y1: 0,
                                x2: 0,
                                y2: 1
                            },
                            stops: [
                                [0, 'rgba(78, 115, 223, 0.5)'],
                                [1, 'rgba(78, 115, 223, 0.05)']
                            ]
                        },
                        marker: {
                            radius: 4
                        },
                        lineWidth: 2,
                        states: {
                            hover: {
                                lineWidth: 2
                            }
                        },
                        threshold: null
                    }
                },
                series: [{
                    name: 'Sales',
                    data: @Html.Raw(ViewBag.ChartData),
                    color: '#4e73df'
                }],
                credits: {
                    enabled: false
                }
            });

            // Baki Trend Chart
            Highcharts.chart('bakiChart', {
                chart: {
                    type: 'line'
                },
                title: {
                    text: null
                },
                xAxis: {
                    categories: @Html.Raw(ViewBag.BakiChartLabels ?? ViewBag.ChartLabels)
                },
                yAxis: {
                    title: {
                        text: 'Baki Amount (BDT)'
                    }
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    line: {
                        marker: {
                            radius: 5
                        },
                        lineWidth: 3,
                        states: {
                            hover: {
                                lineWidth: 3
                            }
                        }
                    }
                },
                series: [{
                    name: 'Baki',
                    data: @Html.Raw(ViewBag.BakiChartData ?? "[0,0,0,0,0,0,0]"),
                    color: '#f05959'
                }],
                credits: {
                    enabled: false
                }
            });

            // POS Sales Distribution Pie Chart
            Highcharts.chart('posPieChart', {
                chart: {
                    type: 'pie'
                },
                title: {
                    text: null
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b><br/>Amount: <b>${point.y}</b>'
                },
                accessibility: {
                    point: {
                        valueSuffix: '%'
                    }
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    name: 'Sales',
                    colorByPoint: true,
                    data: @Html.Raw(ViewBag.POSPieData ?? "[{name: 'Cash', y: 0}, {name: 'Credit', y: 0}, {name: 'Baki', y: 0}]")
                }],
                credits: {
                    enabled: false
                }
            });
        }

        // Print QR Code
        function printQRCode() {
            var printContents = document.querySelector('.modal-body').innerHTML;
            var originalContents = document.body.innerHTML;
            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
            location.reload();
        }

        // Download QR Code
        function downloadQRCode() {
            var qrImage = document.querySelector('.qr-code-container img');
            if (qrImage) {
                var link = document.createElement('a');
                link.href = qrImage.src;
                link.download = 'shop-qr-code.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('QR Code not available for download');
            }
        }
    </script>
}

<style>
    .border-left-primary { border-left: 4px solid #4e73df !important; }
    .border-left-success { border-left: 4px solid #1cc88a !important; }
    .border-left-info { border-left: 4px solid #36b9cc !important; }
    .border-left-warning { border-left: 4px solid #f6c23e !important; }
    .border-left-danger { border-left: 4px solid #e74a3b !important; }
    
    /* Tab styling for chart card */
    #trendChartTabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        background: transparent;
    }
    
    #trendChartTabs .nav-link:hover {
        border-bottom-color: rgba(255, 255, 255, 0.5);
    }
    
    #trendChartTabs .nav-link.active {
        background: transparent;
        border-bottom-color: white;
        font-weight: bold;
    }
</style>
