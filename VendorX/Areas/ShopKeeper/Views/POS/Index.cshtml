@using VendorX.Models
@{
    ViewData["Title"] = "Point of Sale";
    var customers = ViewBag.Customers as List<Customer>;
    var shopId = ViewBag.ShopId;
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0"><i class="bi bi-cart-check"></i> Point of Sale (POS)</h3>
                </div>
                <div class="card-body">
                    <form asp-action="CreateTransaction" method="post" id="posForm">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">Customer</label>
                                <select id="customerId" name="CustomerId" class="form-select" required>
                                    <option value="">-- Select Customer --</option>
                                    @if (customers != null)
                                    {
                                        foreach (var customer in customers)
                                        {
                                            <option value="@customer.CustomerId">@customer.FullName - @customer.PhoneNumber</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Transaction Date</label>
                                <input type="date" id="transactionDate" name="TransactionDate" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Notes</label>
                                <input type="text" name="Notes" class="form-control" placeholder="Optional notes" />
                            </div>
                        </div>

                        <!-- Product Selection -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5><i class="bi bi-box-seam"></i> Add Products</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Select Product</label>
                                        <select id="productSelect" class="form-select">
                                            <option value="">-- Select Product --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" id="productQuantity" class="form-control" value="1" min="1" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" id="addProductBtn" class="btn btn-primary w-100">
                                            <i class="bi bi-plus-circle"></i> Add
                                        </button>
                                    </div>
                                </div>

                                <!-- Cart Table -->
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="cartTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Product</th>
                                                <th style="width: 100px;">Quantity</th>
                                                <th style="width: 120px;">Unit Price</th>
                                                <th style="width: 120px;">Total</th>
                                                <th style="width: 80px;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cartBody">
                                            <tr class="text-center text-muted">
                                                <td colspan="5">No items added yet</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5><i class="bi bi-cash-coin"></i> Payment Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Total Amount</label>
                                        <input type="text" id="totalAmount" name="TotalAmount" class="form-control form-control-lg" readonly />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Amount Paid</label>
                                        <input type="number" id="amountPaid" name="AmountPaid" class="form-control form-control-lg" min="0" step="0.01" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Amount Due (Baki)</label>
                                        <input type="text" id="amountDue" name="AmountDue" class="form-control form-control-lg text-danger" readonly />
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div class="form-check">
                                            <input type="checkbox" id="isCredit" name="IsCredit" value="true" class="form-check-input" />
                                            <label class="form-check-label" for="isCredit">
                                                This is a credit transaction (Baki will be recorded)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn" disabled>
                                <i class="bi bi-check-circle"></i> Complete Transaction
                            </button>
                            <a asp-area="ShopKeeper" asp-controller="Home" asp-action="Index" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>

                        <!-- Hidden Items Container -->
                        <div id="itemsContainer"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const shopId = @(ViewBag.ShopId ?? 0);
        let products = [];
        let cartItems = [];

        // Load products when page loads
        $(document).ready(function() {
            console.log('POS System initialized');
            console.log('Shop ID:', shopId);
            
            if (shopId > 0) {
                loadProducts();
            } else {
                console.error('Invalid shop ID');
                alert('Unable to load shop information. Please contact support.');
            }
            
            $('#amountPaid').on('input', calculateChange);
        });

        // Load products from API
        function loadProducts() {
            console.log('Loading products for shop ID:', shopId);
            $.ajax({
                url: '@Url.Action("GetProducts", "POS")',
                type: 'GET',
                data: { shopId: shopId },
                success: function(data) {
                    console.log('Products loaded:', data);
                    products = data;
                    const select = $('#productSelect');
                    select.empty();
                    select.append('<option value="">-- Select Product --</option>');
                    
                    if (data && data.length > 0) {
                        data.forEach(product => {
                            select.append(`<option value="${product.productId}" data-price="${product.price}" data-stock="${product.stockQuantity}">${product.productName} - $${product.price.toFixed(2)} (Stock: ${product.stockQuantity})</option>`);
                        });
                        console.log('Products added to dropdown');
                    } else {
                        console.warn('No products found for this shop');
                        select.append('<option value="" disabled>No products available</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading products:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                    alert('Failed to load products. Please refresh the page.');
                }
            });
        }

        // Add product to cart
        $('#addProductBtn').click(function() {
            const select = $('#productSelect');
            const productId = select.val();
            const quantity = parseInt($('#productQuantity').val());

            if (!productId) {
                alert('Please select a product');
                return;
            }

            const selectedOption = select.find(':selected');
            const productName = selectedOption.text().split(' - ')[0];
            const unitPrice = parseFloat(selectedOption.data('price'));
            const stock = parseInt(selectedOption.data('stock'));

            if (quantity > stock) {
                alert('Quantity exceeds available stock');
                return;
            }

            // Check if product already in cart
            const existingItem = cartItems.find(item => item.productId === parseInt(productId));
            if (existingItem) {
                existingItem.quantity += quantity;
                existingItem.totalPrice = existingItem.quantity * existingItem.unitPrice;
            } else {
                cartItems.push({
                    productId: parseInt(productId),
                    productName: productName,
                    quantity: quantity,
                    unitPrice: unitPrice,
                    totalPrice: quantity * unitPrice
                });
            }

            updateCartTable();
            select.val('');
            $('#productQuantity').val(1);
        });

        // Remove item from cart
        function removeItem(index) {
            cartItems.splice(index, 1);
            updateCartTable();
        }

        // Update cart table
        function updateCartTable() {
            const tbody = $('#cartBody');
            tbody.empty();

            if (cartItems.length === 0) {
                tbody.append('<tr class="text-center text-muted"><td colspan="5">No items added yet</td></tr>');
                $('#submitBtn').prop('disabled', true);
            } else {
                cartItems.forEach((item, index) => {
                    tbody.append(`
                        <tr>
                            <td>${item.productName}</td>
                            <td><input type="number" class="form-control form-control-sm" value="${item.quantity}" min="1" onchange="updateQuantity(${index}, this.value)" /></td>
                            <td>$${item.unitPrice.toFixed(2)}</td>
                            <td>$${item.totalPrice.toFixed(2)}</td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${index})"><i class="bi bi-trash"></i></button></td>
                        </tr>
                    `);
                });
                $('#submitBtn').prop('disabled', false);
            }

            updateTotals();
            updateHiddenInputs();
        }

        // Update quantity
        function updateQuantity(index, newQuantity) {
            cartItems[index].quantity = parseInt(newQuantity);
            cartItems[index].totalPrice = cartItems[index].quantity * cartItems[index].unitPrice;
            updateCartTable();
        }

        // Update totals
        function updateTotals() {
            const total = cartItems.reduce((sum, item) => sum + item.totalPrice, 0);
            $('#totalAmount').val(total.toFixed(2));
            calculateChange();
        }

        // Calculate change
        function calculateChange() {
            const total = parseFloat($('#totalAmount').val()) || 0;
            const paid = parseFloat($('#amountPaid').val()) || 0;
            const due = total - paid;
            $('#amountDue').val(due.toFixed(2));
            
            // Automatically check/uncheck credit transaction
            if (due > 0) {
                $('#isCredit').prop('checked', true);
            } else {
                $('#isCredit').prop('checked', false);
            }
        }

        // Update hidden inputs for form submission
        function updateHiddenInputs() {
            const container = $('#itemsContainer');
            container.empty();
            
            cartItems.forEach((item, index) => {
                container.append(`
                    <input type="hidden" name="Items[${index}].ProductId" value="${item.productId}" />
                    <input type="hidden" name="Items[${index}].ProductName" value="${item.productName}" />
                    <input type="hidden" name="Items[${index}].Quantity" value="${item.quantity}" />
                    <input type="hidden" name="Items[${index}].UnitPrice" value="${item.unitPrice}" />
                    <input type="hidden" name="Items[${index}].TotalPrice" value="${item.totalPrice}" />
                `);
            });
        }

        // Form validation
        $('#posForm').submit(function(e) {
            if (cartItems.length === 0) {
                e.preventDefault();
                alert('Please add at least one item to the cart');
                return false;
            }

            const customerId = $('#customerId').val();
            if (!customerId) {
                e.preventDefault();
                alert('Please select a customer');
                return false;
            }

            // Ensure IsCredit is set correctly based on amount due
            const amountDue = parseFloat($('#amountDue').val()) || 0;
            if (amountDue > 0) {
                $('#isCredit').prop('checked', true);
            }

            return true;
        });
    </script>
}
